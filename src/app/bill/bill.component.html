<div class="header">
  <span class="bill-name">
    {{ bill.name }}
  </span>
  <p-splitButton
    label="Add item"
    icon="pi pi-plus"
    [model]="menuItems"
    (onClick)="openAddItemDialog()"
    appendTo="body"
  ></p-splitButton>
</div>

<form [formGroup]="itemsForm">
  <ng-container
    *ngFor="let item of itemsForm.controls | keyvalue: orderByDate"
    [formGroupName]="item.key"
  >
    <div class="item-header">
      <div class="description">
        {{ bill.items[item.key].description }}
      </div>
      <div class="price">
        Â£{{ bill.items[item.key].cost }}
        <div class="paid-by">
          paid by
          <span class="name">
            {{ bill.items[item.key].paidBy }}
          </span>
        </div>
      </div>
    </div>
    <div formGroupName="sharedBy" class="sharedBy-grid">
      <div
        class="p-mb-3"
        [ngClass]="{ 'justify-self-right': j % 2 === 1 }"
        *ngFor="
          let sharedBy of sharedByForm(item.key).controls | keyvalue;
          let j = index
        "
        [formGroupName]="sharedBy.key"
      >
        <label class="p-mr-2" *ngIf="j % 2 === 1">{{
          bill.items[item.key].sharedBy[sharedBy.key].user
        }}</label>
        <p-inputSwitch
          formControlName="settled"
          pTooltip="Can't edit the original payer of the item"
          [tooltipDisabled]="
            bill.items[item.key].sharedBy[sharedBy.key].user !==
            bill.items[item.key].paidBy
          "
          tooltipPosition="top"
          (onChange)="
            settledChange$.next({
              checked: $event.checked,
              itemKey: item.key,
              sharedByKey: sharedBy.key,
              billId: bill.uid
            })
          "
        ></p-inputSwitch>
        <label class="p-ml-2" *ngIf="j % 2 === 0">{{
          bill.items[item.key].sharedBy[sharedBy.key].user
        }}</label>
      </div>
    </div>
    <hr />
  </ng-container>
</form>

<p-dialog
  header="Add Item"
  [(visible)]="displayAddItemDialog"
  [style]="{ width: '100%' }"
  [modal]="true"
  [dismissableMask]="true"
>
  <bc-add-item
    [users]="bill.usersArray"
    (addItem)="
      addItem.emit({ newItem: $event, bill: bill }); closeAddItemDialog()
    "
  ></bc-add-item>
</p-dialog>

<p-dialog
  header="Add Users and Editors"
  [(visible)]="displayAddUsersDialog"
  [style]="{ width: '100%' }"
  [modal]="true"
  [dismissableMask]="true"
>
  <bc-add-users-editors
    (addUsersEditors)="
      addUsersEditors.emit({ usersAndEditors: $event, bill: bill });
      closeAddUsersDialog()
    "
  ></bc-add-users-editors>
</p-dialog>

<p-dialog
  header="Calculate"
  [(visible)]="displayCalculateDialog"
  [style]="{ width: '100%' }"
  [modal]="true"
  [dismissableMask]="true"
>
  <bc-calculate *ngIf="displayCalculateDialog" [bill]="bill"></bc-calculate>
</p-dialog>
