rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null
    }

    match /bills/{billDoc} {
      function isEditor() {
      	return request.auth.uid in resource.data.users || request.auth.uid in resource.data.editors // TODO need to delete the first part when we move to new schema
      }
      function isCreator() {
      	return request.auth.uid == resource.data.creatorUid
      }

      allow read: if isSignedIn() && isEditor();
      
    	allow create: if isSignedIn() &&
        request.auth.uid in request.resource.data.users &&
      	request.resource.data.creatorUid == request.auth.uid &&
        request.resource.data.name is string &&
        request.resource.data.name.size() >= 1 &&
        request.resource.data.name.size() <= 20 &&
        request.auth.uid in request.resource.data.users &&
        request.resource.data.usersArray.size() > 0;
      
      allow update: if isSignedIn() && isEditor() &&
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['name', 'creatorUid']);
        // might be better to do the other rules inside a cloud function
      
      allow delete: if isCreator();
    }

    match /users/{userDoc} {
      allow read: if isSignedIn() && userDoc == request.auth.uid

      // only allow update of primaryBill
      allow update: if isSignedIn() && userDoc == request.auth.uid
        && (request.resource.data.keys().hasOnly(['primaryBill']))
    }
  }
}